<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PicSwipe</title>
    <style>
        :root { --keep: #4caf50; --discard: #f44336; --maybe: #ff9800; --bg: #121212; --panel: #1f1f1f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        header { padding: 0 20px; height: 50px; flex-shrink: 0; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .header-left { display: flex; align-items: center; gap: 15px; }

        .stats { display: flex; gap: 15px; font-size: 0.85rem; background: #2a2a2a; padding: 5px 15px; border-radius: 4px; border: 1px solid #333; }
        .stat-item { display: flex; gap: 5px; align-items: center; }
        .stat-val { font-weight: bold; }

        .status-indicator { font-weight: 900; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; width: 120px; text-align: center; }

        main { flex: 1; position: relative; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #render-stage { cursor: zoom-in; max-width: 100%; max-height: 100%; display: block; }

        .toolbar { height: 50px; flex-shrink: 0; background: #181818; display: flex; align-items: center; justify-content: center; gap: 15px; border-top: 1px solid #333; }

        .btn { padding: 6px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; color: white; transition: transform 0.1s; font-size: 0.9rem; }
        .btn:active { transform: scale(0.96); }
        .btn-k { background: var(--keep); }
        .btn-m { background: var(--maybe); color: #000; }
        .btn-d { background: var(--discard); }

        .thumbnail-bar { height: 100px; flex-shrink: 0; background: #111; display: flex; gap: 4px; padding: 5px; overflow-x: auto; border-top: 1px solid #333; align-items: center; scroll-behavior: smooth; }
        .thumb-wrapper { flex-shrink: 0; width: 80px; height: 80px; background: #222; border-radius: 3px; overflow: hidden; cursor: pointer; border: 2px solid transparent; opacity: 0.6; }
        .thumb-wrapper.active { border-color: #fff; opacity: 1; transform: scale(1.02); z-index: 10; }
        .thumb-wrapper.keep { border-bottom: 5px solid var(--keep); opacity: 0.8; }
        .thumb-wrapper.discard { border-bottom: 5px solid var(--discard); opacity: 0.5; filter: grayscale(1); }
        .thumb-wrapper.maybe { border-bottom: 5px solid var(--maybe); opacity: 0.9; }

        canvas.thumb-canvas { width: 100%; height: 100%; display: block; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <input type="file" id="folder-input" webkitdirectory directory multiple style="display:none">
        <button class="btn" style="background:#444" onclick="document.getElementById('folder-input').click()">Open Folder</button>

        <div class="stats">
            <div class="stat-item" style="color:#aaa">Total: <span id="stat-total" class="stat-val">0</span></div>
            <div class="stat-item" style="color:#aaa">Left: <span id="stat-remain" class="stat-val">0</span></div>
            <div style="width:1px; background:#444; height:15px;"></div>
            <div class="stat-item" style="color:var(--keep)">Keep: <span id="stat-keep" class="stat-val">0</span></div>
            <div class="stat-item" style="color:var(--maybe)">Maybe: <span id="stat-maybe" class="stat-val">0</span></div>
            <div class="stat-item" style="color:var(--discard)">Discard: <span id="stat-discard" class="stat-val">0</span></div>
        </div>
    </div>
    <div id="status-indicator" class="status-indicator"></div>
    <button id="finish-btn" class="btn btn-k" disabled>Finish & Get Script</button>
</header>

<main id="main-container">
    <canvas id="render-stage"></canvas>
</main>

<div class="toolbar">
    <button class="btn btn-k" onclick="decide('keep')">A - Keep</button>
    <button class="btn btn-m" onclick="decide('maybe')">W - Maybe</button>
    <button class="btn btn-d" onclick="decide('discard')">D - Discard</button>
    <div style="width:1px; background:#444; height:20px; margin:0 10px;"></div>
    <button class="btn" style="background:#555" onclick="undo()">S - Undo</button>
</div>

<div id="thumb-bar" class="thumbnail-bar"></div>

<script>
    let images = [];
    let currentIndex = 0;
    let lastActiveIndex = 0;
    let history = [];
    let isZoomed = false;
    let currentImg = new Image();
    let currentUrl = null;

    // State tracking for O(1) stats updates
    const counts = { keep: 0, maybe: 0, discard: 0, total: 0 };

    const folderInput = document.getElementById('folder-input');
    const thumbBar = document.getElementById('thumb-bar');
    const canvas = document.getElementById('render-stage');
    const ctx = canvas.getContext('2d', { alpha: false });
    const container = document.getElementById('main-container');
    const statusEl = document.getElementById('status-indicator');

    // Optimization: Lazy Load Thumbnails using Intersection Observer
    const thumbObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const idx = entry.target.dataset.index;
                renderThumb(idx);
                thumbObserver.unobserve(entry.target);
            }
        });
    }, { root: thumbBar, rootMargin: '100px' });

    function draw(mouseX = canvas.width/2, mouseY = canvas.height/2) {
        if (!currentImg.complete) return;

        if (canvas.width !== container.clientWidth || canvas.height !== container.clientHeight) {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        const cw = canvas.width, ch = canvas.height;
        const iw = currentImg.naturalWidth, ih = currentImg.naturalHeight;
        const ratio = Math.min(cw / iw, ch / ih);
        const nw = iw * ratio, nh = ih * ratio;
        const left = (cw - nw) / 2, top = (ch - nh) / 2;

        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, cw, ch);

        if (!isZoomed) {
            ctx.drawImage(currentImg, left, top, nw, nh);
        } else {
            const zoomLevel = 3.5;
            const normX = Math.max(0, Math.min(1, (mouseX - left) / nw));
            const normY = Math.max(0, Math.min(1, (mouseY - top) / nh));
            const znw = nw * zoomLevel, znh = nh * zoomLevel;
            ctx.drawImage(currentImg, -(normX * znw - mouseX), -(normY * znh - mouseY), znw, znh);
        }
    }

    async function showImage(index) {
        if (index < 0 || index >= images.length) return;

        // Targeted UI update: Only update the two elements involved
        document.getElementById(`wrapper-${lastActiveIndex}`)?.classList.remove('active');
        const nextThumb = document.getElementById(`wrapper-${index}`);
        nextThumb?.classList.add('active');

        lastActiveIndex = index;
        currentIndex = index;
        isZoomed = false;

        if (currentUrl) URL.revokeObjectURL(currentUrl);
        currentUrl = URL.createObjectURL(images[currentIndex].file);

        currentImg = new Image();
        currentImg.onload = () => {
            draw();
            updateLabels();
        };
        currentImg.src = currentUrl;

        if(nextThumb) nextThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }

    function renderThumb(idx) {
        const tc = document.getElementById(`canvas-${idx}`);
        if (!tc || tc.dataset.rendered) return;

        const img = new Image();
        const url = URL.createObjectURL(images[idx].file);
        img.onload = () => {
            const tctx = tc.getContext('2d', { alpha: false });
            tc.width = 100; tc.height = 100;
            const minDim = Math.min(img.naturalWidth, img.naturalHeight);
            const sx = (img.naturalWidth - minDim) / 2;
            const sy = (img.naturalHeight - minDim) / 2;
            tctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, 100, 100);
            URL.revokeObjectURL(url);
            tc.dataset.rendered = "true";
        };
        img.src = url;
    }

    function updateLabels() {
        const item = images[currentIndex];
        statusEl.innerText = item.decision || "";
        statusEl.style.color = item.decision ? `var(--${item.decision})` : 'transparent';

        document.getElementById('stat-remain').innerText = counts.total - (counts.keep + counts.maybe + counts.discard);
        document.getElementById('stat-keep').innerText = counts.keep;
        document.getElementById('stat-maybe').innerText = counts.maybe;
        document.getElementById('stat-discard').innerText = counts.discard;
    }

    function decide(type) {
        const item = images[currentIndex];
        if (!item) return;

        history.push({ index: currentIndex, prevDecision: item.decision });

        // Incremental count update
        if (item.decision) counts[item.decision]--;
        item.decision = type;
        counts[type]++;

        const el = document.getElementById(`wrapper-${currentIndex}`);
        el.className = `thumb-wrapper active ${type}`;

        if (currentIndex < images.length - 1) showImage(currentIndex + 1);
        else updateLabels();
    }

    function undo() {
        if (history.length === 0) return;
        const last = history.pop();
        const item = images[last.index];

        if (item.decision) counts[item.decision]--;
        if (last.prevDecision) counts[last.prevDecision]++;
        item.decision = last.prevDecision;

        const el = document.getElementById(`wrapper-${last.index}`);
        el.className = `thumb-wrapper ${item.decision || ''}`;

        showImage(last.index);
    }

    folderInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files)
            .filter(f => /\.(jpe?g|png|webp|jfif)$/i.test(f.name) && f.webkitRelativePath.split('/').length === 2)
            .sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));

        if (files.length === 0) return alert("No root-level images found.");

        images = files.map(file => ({ file, decision: null }));
        counts.total = images.length;
        counts.keep = 0; counts.maybe = 0; counts.discard = 0;

        document.getElementById('stat-total').innerText = counts.total;
        document.getElementById('finish-btn').disabled = false;
        thumbBar.innerHTML = '';

        const fragment = document.createDocumentFragment();
        images.forEach((_, i) => {
            const w = document.createElement('div');
            w.className = 'thumb-wrapper';
            w.id = `wrapper-${i}`;
            w.dataset.index = i;
            w.onclick = () => showImage(i);
            w.innerHTML = `<canvas class="thumb-canvas" id="canvas-${i}"></canvas>`;
            fragment.appendChild(w);
            thumbObserver.observe(w); // Observe for lazy loading
        });
        thumbBar.appendChild(fragment);
        showImage(0);
    });

    // Efficient event listeners
    canvas.addEventListener('mousedown', (e) => {
        isZoomed = !isZoomed;
        const rect = canvas.getBoundingClientRect();
        draw(e.clientX - rect.left, e.clientY - rect.top);
    });

    canvas.addEventListener('mousemove', (e) => {
        if (isZoomed) {
            const rect = canvas.getBoundingClientRect();
            requestAnimationFrame(() => draw(e.clientX - rect.left, e.clientY - rect.top));
        }
    });

    window.addEventListener('resize', () => requestAnimationFrame(() => draw()));

    window.addEventListener('keydown', (e) => {
        if (!images.length) return;
        const k = e.key.toLowerCase();
        if (k === 'a') decide('keep');
        else if (k === 'w') decide('maybe');
        else if (k === 'd') decide('discard');
        else if (k === 's') undo();
        else if (k === ' ') { e.preventDefault(); isZoomed = !isZoomed; draw(); }
        else if (e.key === 'ArrowLeft') showImage(currentIndex - 1);
        else if (e.key === 'ArrowRight') showImage(currentIndex + 1);
    });

    document.getElementById('finish-btn').onclick = () => {
        const script = "#!/bin/bash\nmkdir -p discard maybe\n" +
            images.filter(i => i.decision === 'discard').map(i => `mv "${i.file.name}" discard/`).join("\n") + "\n" +
            images.filter(i => i.decision === 'maybe').map(i => `mv "${i.file.name}" maybe/`).join("\n");
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([script], {type:'text/plain'}));
        a.download = "cleanup.sh"; a.click();
    };
</script>
</body>
</html>
